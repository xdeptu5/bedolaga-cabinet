name: Auto Sync Fork

on:
  schedule:
    - cron: '0 * * * *' # –ö–∞–∂–¥—ã–µ 60 –º–∏–Ω—É—Ç
  workflow_dispatch: # –ú–æ–∂–Ω–æ —Ç—ã–∫–Ω—É—Ç—å –∫–Ω–æ–ø–∫—É –≤—Ä—É—á–Ω—É—é

jobs:
  sync:
    runs-on: ubuntu-latest
    # –î–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ—Ä–∫—Ñ–ª–æ—É (–¥–ª—è –ø–∏–Ω–∫–∞ –¥–µ–ø–ª–æ—è)
    permissions:
      contents: write
      actions: write
    
    steps:
      # 1. –ó–∞–±–∏—Ä–∞–µ–º —Ç–≤–æ–π –∫–æ–¥
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. –í—Ç—è–≥–∏–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
      - name: Sync logic
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          git remote add upstream https://github.com/BEDOLAGA-DEV/bedolaga-cabinet.git
          git fetch upstream main
          
          # –°–ª–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è. –ï—Å–ª–∏ –±—É–¥—É—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã ‚Äî —à–∞–≥ —É–ø–∞–¥–µ—Ç.
          git merge upstream/main --no-edit || (echo "CONFLICT DETECTED" && exit 1)
          
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 3. –ü–ò–ù–ê–ï–ú –î–ï–ü–õ–û–ô (–¢–æ—Ç —Å–∞–º—ã–π —à–∞–≥, –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ —Ö–≤–∞—Ç–∞–ª–æ)
      - name: Trigger Deploy Pipeline
        if: success()
        run: |
          echo "–ó–∞–ø—É—Å–∫–∞—é CI/CD Pipeline..."
          gh workflow run "CI/CD Pipeline" --ref main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 4. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –¢–µ–ª–µ–≥—Ä–∞–º (–≤ —Ç–≤–æ–π —Ç–æ–ø–∏–∫)
      - name: Send Notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            ICON="‚úÖ"
            STATUS="Sync & Trigger Successful"
          else
            ICON="‚ùå"
            STATUS="Sync Failed (Check Conflicts)"
          fi

          MESSAGE="<b>Safexess VPN Bot</b>%0A$ICON <b>$STATUS</b>%0A%0Aüì¶ <b>Repository:</b> ${{ github.repository }}%0Aüèπ <b>Workflow:</b> ${{ github.workflow }}"
          
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d "message_thread_id=${{ secrets.TELEGRAM_TOPIC_ID }}" \
          -d "parse_mode=HTML" \
          -d "text=$MESSAGE"
