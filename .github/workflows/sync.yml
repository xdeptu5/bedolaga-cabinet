name: Auto Sync Fork

on:
  schedule:
    - cron: '0 * * * *' # –†–∞–∑ –≤ —á–∞—Å
  workflow_dispatch: # –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

jobs:
  sync:
    runs-on: ubuntu-latest
    # –î–ê–ï–ú –ü–†–ê–í–ê: –ë–µ–∑ —ç—Ç–æ–≥–æ –±—É–¥–µ—Ç –æ—à–∏–±–∫–∞ 128
    permissions:
      contents: write
      actions: write
    
    steps:
      # 1. –°–ö–ê–ß–ò–í–ê–ï–ú –¢–í–û–ô –†–ï–ü–û
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. –û–ë–´–ß–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï (Update Branch)
      - name: Standard Merge Sync
        id: sync_step
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –∫–æ–º–º–∏—Ç–∞ –¥–æ –Ω–∞—á–∞–ª–∞
          OLD_HASH=$(git rev-parse HEAD)
          
          # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª –∏ –º–µ—Ä–¥–∂–∏–º
          git remote add upstream https://github.com/BEDOLAGA-DEV/bedolaga-cabinet.git
          git fetch upstream main
          git merge upstream/main --no-edit
          
          # –ü—É—à–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          git push origin main
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ—è–≤–∏–ª–∏—Å—å –ª–∏ –Ω–æ–≤—ã–µ –∫–æ–º–º–∏—Ç—ã
          NEW_HASH=$(git rev-parse HEAD)
          if [ "$OLD_HASH" != "$NEW_HASH" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 3. –ó–ê–ü–£–°–ö –î–ï–ü–õ–û–Ø (–ï—Å–ª–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è)
      - name: Trigger Deploy
        if: steps.sync_step.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh workflow run deploy.yml --ref main

      # 4. –û–¢–ß–ï–¢ –í –¢–ï–õ–ï–ì–£
      - name: Send Notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ] && [ "${{ steps.sync_step.outputs.has_changes }}" = "true" ]; then
            ICON="‚úÖ"
            STATUS="Branch Updated & Deploy Started"
          elif [ "${{ steps.sync_step.outputs.has_changes }}" = "false" ]; then
            ICON="üí§"
            STATUS="Already up to date"
          else
            ICON="‚ùå"
            STATUS="Sync Failed (Merge Conflict)"
          fi

          MESSAGE="<b>Safexess VPN Bot</b>%0A$ICON <b>$STATUS</b>%0A%0Aüì¶ <b>Repo:</b> ${{ github.repository }}"
          
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d "message_thread_id=${{ secrets.TELEGRAM_TOPIC_ID }}" \
          -d "parse_mode=HTML" \
          -d "text=$MESSAGE"
