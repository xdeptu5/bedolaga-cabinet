name: Auto Sync Fork

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync logic
        id: sync_step # –î–æ–±–∞–≤–ª—è–µ–º ID, —á—Ç–æ–±—ã –≤—ã—Ç–∞—â–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          # –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ö–µ—à –∫–æ–º–º–∏—Ç–∞
          OLD_HASH=$(git rev-parse HEAD)
          
          git remote add upstream https://github.com/BEDOLAGA-DEV/bedolaga-cabinet.git
          git fetch upstream main
          
          # –ü—ã—Ç–∞–µ–º—Å—è —Å–ª–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git merge upstream/main --no-edit || (echo "CONFLICT" && exit 1)
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ —Ö–µ—à –ø–æ—Å–ª–µ –º–µ—Ä–¥–∂–∞
          NEW_HASH=$(git rev-parse HEAD)
          
          if [ "$OLD_HASH" != "$NEW_HASH" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            git push origin main
            echo "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–æ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è."
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "–ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger Deploy Pipeline
        # –ó–∞–ø—É—Å–∫–∞–µ–º, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ sync_step –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –Ω–∞–ª–∏—á–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        if: steps.sync_step.outputs.has_changes == 'true'
        run: |
          echo "–ó–∞–ø—É—Å–∫–∞—é —Å–±–æ—Ä–∫—É..."
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è –§–ê–ô–õ–ê –≤–æ—Ä–∫—Ñ–ª–æ—É –≤–º–µ—Å—Ç–æ –µ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è
          gh workflow run deploy.yml --ref main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send Notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "failure" ]; then
            ICON="‚ùå"
            STATUS="Sync Failed (Conflict)"
          elif [ "${{ steps.sync_step.outputs.has_changes }}" = "true" ]; then
            ICON="‚úÖ"
            STATUS="Sync & Deploy Triggered"
          else
            # –ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ –±—ã–ª–æ, –º–æ–∂–Ω–æ –ª–∏–±–æ –º–æ–ª—á–∞—Ç—å, –ª–∏–±–æ —Å–ª–∞—Ç—å "Idle"
            ICON="üí§"
            STATUS="No updates found"
          fi

          MESSAGE="<b>Safexess VPN Bot</b>%0A$ICON <b>$STATUS</b>%0A%0Aüì¶ <b>Repository:</b> ${{ github.repository }}"
          
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d "message_thread_id=${{ secrets.TELEGRAM_TOPIC_ID }}" \
          -d "parse_mode=HTML" \
          -d "text=$MESSAGE"
