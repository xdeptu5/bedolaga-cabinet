name: Auto Sync Fork

on:
  schedule:
    - cron: '0 * * * *' # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–π —á–∞—Å
  workflow_dispatch: # –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write # –ù—É–∂–Ω–æ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –¥–µ–ø–ª–æ—è

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Standard Merge Sync
        id: sync_step
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          OLD_HASH=$(git rev-parse HEAD)
          
          git remote add upstream https://github.com/BEDOLAGA-DEV/bedolaga-cabinet.git
          git fetch upstream main
          
          # –û–±—ã—á–Ω—ã–π –º–µ—Ä–¥–∂ –∏–∑–º–µ–Ω–µ–Ω–∏–π
          git merge upstream/main --no-edit || (echo "Merge failed" && exit 1)
          
          git push origin main
          
          NEW_HASH=$(git rev-parse HEAD)
          if [ "$OLD_HASH" != "$NEW_HASH" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger Deploy Pipeline
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
        if: steps.sync_step.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # –§–ª–∞–≥ --repo –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç 404, —É–∫–∞–∑—ã–≤–∞—è –Ω–∞ —Ç–≤–æ–π —Ñ–æ—Ä–∫
          gh workflow run deploy.yml --ref main --repo ${{ github.repository }}

      # –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –ü–†–ò –£–°–ü–ï–•–ï (–¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è)
      - name: Send Success Notification
        if: success() && steps.sync_step.outputs.has_changes == 'true'
        run: |
          MESSAGE="<b>Safexess VPN Bot</b>%0A‚úÖ <b>Sync & Deploy Started</b>%0A%0Aüì¶ <b>Repo:</b> ${{ github.repository }}"
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d "message_thread_id=${{ secrets.TELEGRAM_TOPIC_ID }}" \
          -d "parse_mode=HTML" \
          -d "text=$MESSAGE"

      # –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –ü–†–ò –û–®–ò–ë–ö–ï
      - name: Send Failure Notification
        if: failure()
        run: |
          MESSAGE="<b>Safexess VPN Bot</b>%0A‚ùå <b>Sync Failed (Conflict or Error)</b>%0A%0Aüì¶ <b>Repo:</b> ${{ github.repository }}"
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d "message_thread_id=${{ secrets.TELEGRAM_TOPIC_ID }}" \
          -d "parse_mode=HTML" \
          -d "text=$MESSAGE"
